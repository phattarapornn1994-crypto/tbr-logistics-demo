<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Logistics Planner 3D | Recycling Fleet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Widgets/widgets.css">
  <style>
    :root {
      --brand:#168f3a;
      --bg:#f4f6f4;
      --ink:#132321;
      --card:#ffffff;
      --border:#d6e4da;
    }
    *{box-sizing:border-box;font-family:"Segoe UI","Kanit",sans-serif;}
    body{margin:0;display:flex;flex-direction:row;height:100vh;background:var(--bg);color:var(--ink);}
    #sidebar{
      width:360px;
      padding:14px;
      border-right:1px solid var(--border);
      background:rgba(255,255,255,0.97);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .brand{
      font-weight:700;
      font-size:18px;
      color:var(--brand);
    }
    .tagline{
      font-size:11px;
      color:#6b7b72;
      margin-top:-4px;
    }
    label{font-size:11px;color:#556;margin-top:2px;}
    select,button{
      width:100%;
      padding:6px 8px;
      margin-top:2px;
      font-size:11px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#fff;
    }
    button{
      background:var(--brand);
      color:#fff;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    button:hover{opacity:0.9;}
    .section{
      padding:8px;
      background:var(--card);
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;}
    .chip{
      padding:2px 6px;
      border-radius:999px;
      font-size:9px;
      border:1px solid var(--border);
      background:#f7faf7;
      cursor:pointer;
    }
    .chip.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    #routeSummary{
      font-size:10px;
      line-height:1.5;
      max-height:180px;
      overflow-y:auto;
      margin-top:4px;
      border-top:1px dashed var(--border);
      padding-top:4px;
    }
    .route-row{
      padding:3px 4px;
      border-radius:6px;
      margin-bottom:2px;
      cursor:pointer;
    }
    .route-row:hover{
      background:#eef8f0;
    }
    .route-row.own{border-left:3px solid #168f3a;}
    .route-row.vendor{border-left:3px solid #d62728;}
    #cesiumContainer{flex:1;}
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:9px;
      margin-top:2px;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:3px;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;display:inline-block;
    }
    .dot-plant{background:#1f77b4;}
    .dot-yard{background:#ff7f0e;}
    .dot-js{background:#2ca02c;}
    .dot-depot{background:#9467bd;}
    .dot-route-own{background:#168f3a;}
    .dot-route-out{background:#d62728;}
  </style>
</head>
<body>
  <div id="sidebar">
    <div>
      <div class="brand">Logistics Planner 3D</div>
      <div class="tagline">เห็น Route ชัด • โหลดตามกฎหมาย • เลือกรถคุ้มสุดอัตโนมัติ</div>
    </div>

    <div class="section">
      <label>Scenario การใช้รถ</label>
      <div class="chips" id="scenarioChips">
        <div class="chip active" data-mode="mixed">Mixed (Own + Outsource)</div>
        <div class="chip" data-mode="own">Own Only</div>
        <div class="chip" data-mode="vendor">Outsource Only</div>
      </div>
    </div>
    <div class="section">
  <label>เลือกปลายทางโรงงาน (Plant)</label>
  <select id="plantSelect"></select>

  <label>กรองประเภทจุดรับของ</label>
  <select id="originTypeSelect">
    <option value="all">ทั้งหมด</option>
    <option value="yard">ลาน</option>
    <option value="junkshop">ร้านรับซื้อ</option>
  </select>

  <!-- ปุ่มคำนวณแผนจาก orders -->
  <button id="btnPlan">คำนวณแผนจาก Orders.json</button>

  <!-- ปุ่มเรียก /optimize -->
  <button id="btnTestOptimize" style="margin-top:4px; background:#444;">
    ทดสอบเรียก Optimize API (Cloudflare)
  </button>

  <!-- ส่วนกรอกพารามิเตอร์ -->
  <div style="margin-top:4px; font-size:9px; color:#555;">
    ทดสอบปรับพารามิเตอร์:
  </div>

  <label style="font-size:9px;">ปริมาณรวม (ตัน)</label>
  <input id="optDemand" type="number" step="0.1" value="12"
    style="width:100%;padding:4px 6px;font-size:9px;border-radius:6px;border:1px solid #d6e4da;">

  <label style="font-size:9px;">ระยะทางไป-กลับ (กม.)</label>
  <input id="optDistance" type="number" step="10" value="300"
    style="width:100%;padding:4px 6px;font-size:9px;border-radius:6px;border:1px solid:#d6e4da;">

  <!-- ปุ่มเรียก /tariff/calc -->
  <button id="btnTestTariff" style="margin-top:4px; background:#0066aa;">
    ทดสอบคำนวณค่าขนส่ง (Tariff)
  </button>

  <div style="font-size:8px;color:#888;margin-top:2px;">
    ระบบจะใช้ Scenario ที่เลือกด้านบน (Mixed / Own / Outsource) ในการเปรียบเทียบต้นทุน
  </div>
</div>


      <div class="legend">
        <span><span class="dot dot-plant"></span>Plant</span>
        <span><span class="dot dot-yard"></span>Yard</span>
        <span><span class="dot dot-js"></span>Junk Shop</span>
        <span><span class="dot dot-depot"></span>Depot</span>
        <span><span class="dot dot-route-own"></span>Route Own</span>
        <span><span class="dot dot-route-out"></span>Route Outsource</span>
      </div>
    </div>

    <div class="section">
      <div style="font-size:11px;font-weight:600;">สรุปเส้นทาง & ต้นทุน</div>
      <div id="routeSummary">ระบบจะอ่าน orders.json → รวมโหลดต่อจุด → แบ่งเป็น Route 1,2,3... พร้อมเปรียบเทียบต้นทุน</div>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Cesium.js"></script>
  <script>
    // *** ใส่ Token Cesium Ion ของคุณเองตรงนี้ ***
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkYWQ1OWUwOS1mYjE3LTRkMWItYmVmOC1mNGY2MDljOGJhMWIiLCJpZCI6MzU4MDMzLCJpYXQiOjE3NjI0ODM2ODh9.m6qoHZhEGlI40OWp5E7x5v8YIFIzTTiyhYV5T-50BAQ';

      const viewer = new Cesium.Viewer('cesiumContainer', {
    animation:false,
    timeline:false,
    baseLayerPicker:true,
    geocoder:false,
    sceneModePicker:true
  });

  let locations = [];
  let materials = [];
  let trucks = [];
  let orders = [];
  let scenarioMode = 'mixed';
  let routeEntities = [];

  // โหลด master + orders (ถ้าไม่มี orders.json จะใช้ [] แทน)
  Promise.all([
    fetch('locations.json').then(r => r.json()),
    fetch('materials.json').then(r => r.json()),
    fetch('trucks.json').then(r => r.json()),
    fetch('orders.json').then(r => r.ok ? r.json() : [])
  ]).then(([loc, mat, trk, ord]) => {
    locations = loc;
    materials = mat;
    trucks = trk;
    orders = ord || [];
    initUI();
    plotLocations();
    flyToThailand();
  }).catch(err => {
    console.error(err);
    const el = document.getElementById('routeSummary');
    if (el) el.innerHTML = 'โหลดไฟล์ไม่สำเร็จ: ' + err.message;
  });

function initUI(){
  const plantSelect = document.getElementById('plantSelect');
  if (plantSelect) {
    locations.filter(l => l.type === 'plant').forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.locationId;
      opt.textContent = p.name;
      plantSelect.appendChild(opt);
    });
    if (plantSelect.options.length > 0) {
      plantSelect.selectedIndex = 0;
    }
  }

  const chips = document.querySelectorAll('#scenarioChips .chip');
  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      chips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      scenarioMode = chip.dataset.mode;
    });
  });

  const planBtn = document.getElementById('btnPlan');
  if (planBtn) {
    planBtn.addEventListener('click', buildPlanFromOrders);
  }

  const btnTest = document.getElementById('btnTestOptimize');
  if (btnTest) {
    btnTest.addEventListener('click', callOptimizeDemo);
  }

  const btnTariff = document.getElementById('btnTestTariff');
  if (btnTariff) {
    btnTariff.addEventListener('click', callTariffDemo);
  }
}
    

  function flyToThailand(){
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(100.5, 15.5, 2500000.0)
    });
  }

  function plotLocations(){
    locations.forEach(loc => {
      let color = Cesium.Color.WHITE;
      if(loc.type === 'plant') color = Cesium.Color.fromBytes(31,119,180);
      if(loc.type === 'yard') color = Cesium.Color.fromBytes(255,127,14);
      if(loc.type === 'junkshop') color = Cesium.Color.fromBytes(44,160,44);
      if(loc.type === 'depot') color = Cesium.Color.fromBytes(148,103,189);

      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(loc.lng, loc.lat),
        point: {
          pixelSize: 9,
          color: color,
          outlineColor: Cesium.Color.WHITE,
          outlineWidth: 1
        },
        label: {
          text: loc.name,
          font: '10px sans-serif',
          pixelOffset: new Cesium.Cartesian2(0, -14),
          fillColor: Cesium.Color.fromCssColorString('#223'),
          showBackground: true,
          backgroundColor: Cesium.Color.fromCssColorString('rgba(255,255,255,0.85)'),
          scaleByDistance: new Cesium.NearFarScalar(50000,1.0,800000,0.25)
        },
        properties: {
          locationId: loc.locationId,
          type: loc.type
        }
      });
    });
  }

  function clearRoutes(){
    routeEntities.forEach(r => viewer.entities.remove(r.entity));
    routeEntities = [];
  }

  function buildPlanFromOrders(){
    clearRoutes();
    const summaryEl = document.getElementById('routeSummary');

    const plantSelect = document.getElementById('plantSelect');
    const plantId = plantSelect ? plantSelect.value : null;
    const originTypeFilter = document.getElementById('originTypeSelect')?.value || 'all';
    const plant = locations.find(l => l.locationId === plantId);

    if (!plant) {
      if (summaryEl) summaryEl.innerHTML = 'ยังไม่ได้เลือก Plant หรือไม่มีใน locations.json';
      return;
    }

    const demandByOrigin = {};
    (orders || []).forEach(order => {
      const origin = locations.find(l => l.locationId === order.originLocationId);
      if (!origin) return;
      if (originTypeFilter !== 'all' && origin.type !== originTypeFilter) return;
      if (!demandByOrigin[origin.locationId]) {
        demandByOrigin[origin.locationId] = { weightKg: 0, volumeM3: 0, origin };
      }
      (order.lines || []).forEach(line => {
        const mat = materials.find(m => m.materialId === line.materialId);
        if (!mat) return;
        demandByOrigin[origin.locationId].weightKg += (mat.avgWeightPerUnitKg || 0) * line.qtyUnit;
        demandByOrigin[origin.locationId].volumeM3 += (mat.avgVolumePerUnitM3 || 0) * line.qtyUnit;
      });
    });

    const originIds = Object.keys(demandByOrigin);
    if (originIds.length === 0) {
      if (summaryEl) summaryEl.innerHTML = 'ไม่มี orders ตรงกับ filter หรือยังไม่มี orders.json';
      return;
    }

    const ownTrucks = trucks.filter(t => t.ownerType === 'OWN');
    const vendorTrucks = trucks.filter(t => t.ownerType === 'OUTSOURCE');

    let routeHtml = '';
    let routeIndex = 1;
    let totalCost = 0;
    let totalTon = 0;

    originIds.forEach(originId => {
      const d = demandByOrigin[originId];
      const origin = d.origin;
      let remainingKg = d.weightKg;
      let remainingVol = d.volumeM3;
      if (remainingKg <= 0 || remainingVol <= 0) return;

      const distanceKm = estimateDistanceKm(origin.lat, origin.lng, plant.lat, plant.lng);

      while (remainingKg > 50) {
        const candidates = [];

        if (scenarioMode === 'mixed' || scenarioMode === 'own') {
          ownTrucks.forEach(tr => {
            const cap = computeLoadableTonForTruck(tr, remainingKg, remainingVol, d);
            if (cap.ton > 0) {
              const tripCost = tr.fixedCostPerTrip + tr.costPerKm * distanceKm * 2;
              const cpt = tripCost / cap.ton;
              candidates.push({ mode:'own', truck:tr, ton:cap.ton, cost:tripCost, costPerTon:cpt });
            }
          });
        }

        if (scenarioMode === 'mixed' || scenarioMode === 'vendor') {
          vendorTrucks.forEach(tr => {
            const cap = computeLoadableTonForTruck(tr, remainingKg, remainingVol, d);
            if (cap.ton > 0) {
              let tripCost = 0;
              if (tr.rateType === 'per_ton_km') {
                tripCost = tr.rateValue * distanceKm * 2 * cap.ton;
              } else if (tr.rateType === 'per_km') {
                tripCost = tr.rateValue * distanceKm * 2;
              }
              if (tr.minCharge && tripCost < tr.minCharge) tripCost = tr.minCharge;
              const cpt = tripCost / cap.ton;
              candidates.push({ mode:'vendor', truck:tr, ton:cap.ton, cost:tripCost, costPerTon:cpt });
            }
          });
        }

        if (candidates.length === 0) break;

        candidates.sort((a,b)=>a.costPerTon - b.costPerTon);
        const chosen = candidates[0];

        remainingKg -= chosen.ton * 1000;
        const density = d.volumeM3 > 0 ? (d.weightKg / d.volumeM3) : 1000;
        const usedVol = (chosen.ton * 1000) / density;
        remainingVol -= usedVol;

        const color = (chosen.mode === 'own')
          ? Cesium.Color.fromBytes(22,143,58,230)
          : Cesium.Color.fromBytes(214,39,40,230);

        const entity = viewer.entities.add({
          polyline: {
            positions: Cesium.Cartesian3.fromDegreesArray([
              plant.lng, plant.lat,
              origin.lng, origin.lat,
              plant.lng, plant.lat
            ]),
            width: 2 + chosen.ton, // หนาขึ้นตาม ton
            material: color
          }
        });

const routeId = 'R' + routeIndex;
const modeLabel = chosen.mode === 'own' ? 'รถบริษัท' : 'Outsource';
const truckLabel = chosen.truck.displayName || chosen.truck.vendorName || chosen.truck.truckType || chosen.truck.id;
const loadPct = (chosen.ton * 1000) / (chosen.truck.maxWeightKgLegal || chosen.truck.maxTon * 1000) * 100;
const etaHours = (distanceKm * 2) / 60; // สมมติ 60 km/h
const departTime = "08:00";
const arrivalTime = addHoursToTime(departTime, etaHours);
        
routeEntities.push({
  id: routeId,
  entity,
  mode: chosen.mode,
  originId: origin.locationId,
  plantId: plant.locationId,
  ton: chosen.ton,
  distanceKm: distanceKm * 2 // ไป-กลับ
});

const etaHours = (distanceKm * 2) / 60; // สมมติวิ่งเฉลี่ย 60 กม./ชม.
const departTime = "08:00";
const arrivalTime = addHoursToTime(departTime, etaHours);

routeHtml += `
  <div class="route-row ${chosen.mode === 'own' ? 'own':'vendor'}" data-route-id="${routeId}">
    <b>Route ${routeIndex}:</b> ${origin.name} → ${plant.name}<br/>
    ${modeLabel} (${truckLabel}) |
    Load ~ ${chosen.ton.toFixed(2)} ton (${loadPct.toFixed(0)}% กฎหมาย)<br/>
    Dist ~ ${(distanceKm*2).toFixed(1)} km |
    Cost ≈ ${chosen.cost.toFixed(0)} บาท<br/>
    เวลาออก ${departTime} ~ ถึงประมาณ ${arrivalTime}
  </div>
`;

        totalCost += chosen.cost;
        totalTon += chosen.ton;
        routeIndex++;
      }
    });

    if (routeIndex === 1) {
      if (summaryEl) summaryEl.innerHTML = 'ไม่สามารถจัด Route ได้ (ไม่มี candidates หรือ orders)';
      return;
    }

    if (totalTon > 0) {
      const avg = totalCost / totalTon;
      routeHtml += `
        <hr/>
        <div>
          <b>สรุปทั้งแผน</b><br/>
          ปริมาณรวม ~ ${totalTon.toFixed(2)} ton<br/>
          ต้นทุนรวม ~ ${totalCost.toFixed(0)} บาท<br/>
          ต้นทุนเฉลี่ย ~ ${avg.toFixed(0)} บาท/ton
        </div>
      `;
    }

    if (summaryEl) summaryEl.innerHTML = routeHtml;

    document.querySelectorAll('.route-row').forEach(row => {
      row.addEventListener('click', () => {
        const id = row.getAttribute('data-route-id');
        focusRoute(id);
      });
    });
    enrichRoutesWithTariff();
    // เติมต้นทุนจาก /tariff/calc ให้แต่ละ Route
async function enrichRoutesWithTariff() {
  const summaryEl = document.getElementById('routeSummary');
  if (!summaryEl || routeEntities.length === 0) return;

  try {
    const calls = routeEntities.map(r => {
      const url =
        `/tariff/calc`
        + `?origin=${encodeURIComponent(r.originId)}`
        + `&destination=${encodeURIComponent(r.plantId)}`
        + `&distanceKm=${encodeURIComponent(r.distanceKm)}`
        + `&weightTon=${encodeURIComponent(r.ton)}`
        + `&stops=${encodeURIComponent(3)}`
        + `&vehicleType=${encodeURIComponent('10W')}`
        + `&vendorType=${encodeURIComponent(r.mode === 'own' ? 'OWN' : 'SUB')}`;

      return fetch(url).then(res =>
        res.json().then(data => ({ res, data, id: r.id }))
      );
    });

    const results = await Promise.all(calls);

    results.forEach(({ res, data, id }) => {
      if (!res || !res.ok || !data || !data.breakdown) return;
      const row = document.querySelector(`.route-row[data-route-id="${id}"]`);
      if (!row) return;
      const b = data.breakdown;
      const costPerTon = b.total / (data.input.weightTon || 1);

      const extra = `
        <div style="font-size:9px;color:#444;">
          Tariff Total: ${b.total.toLocaleString()} บาท
          (${costPerTon.toFixed(0)} บ./ton รวมน้ำมัน)
        </div>
      `;
      row.insertAdjacentHTML('beforeend', extra);
    });

    let total = 0;
    let totalTon = 0;
    results.forEach(({ res, data }) => {
      if (!res || !res.ok || !data || !data.breakdown) return;
      total += data.breakdown.total || 0;
      totalTon += data.input.weightTon || 0;
    });

    if (totalTon > 0) {
      const avg = total / totalTon;
      summaryEl.insertAdjacentHTML(
        'beforeend',
        `
        <hr/>
        <div style="font-size:10px;">
          <b>Tariff Summary (ทุก Route):</b><br/>
          รวมต้นทุนตาม Tariff ~ ${total.toLocaleString()} บาท<br/>
          เฉลี่ย ~ ${avg.toFixed(0)} บาท/ton
        </div>
        `
      );
    }
  } catch (err) {
    console.error(err);
  }
}

  }
function addHoursToTime(timeStr, hours) {
  const [h, m] = timeStr.split(':').map(Number);
  const totalMinutes = h * 60 + m + Math.round(hours * 60);
  const hh = Math.floor((totalMinutes / 60) % 24).toString().padStart(2, '0');
  const mm = (totalMinutes % 60).toString().padStart(2, '0');
  return `${hh}:${mm}`;
}

  function computeLoadableTonForTruck(truck, remainingKg, remainingVol, demand){
    const legalKg = truck.maxWeightKgLegal || (truck.maxTon ? truck.maxTon * 1000 : 0);
    const maxTonByWeight = legalKg > 0 ? legalKg / 1000 : 9999;
    const density = demand.volumeM3 > 0 ? (demand.weightKg / demand.volumeM3) : 1000;
    const maxTonByVolume = (truck.maxVolumeM3 || 9999) * density / 1000;
    let maxTon = Math.min(maxTonByWeight, maxTonByVolume);
    const remainTon = remainingKg / 1000;
    if (maxTon > remainTon) maxTon = remainTon;
    if (maxTon < 0.5) return { ton:0 };
    return { ton:maxTon };
  }

  function focusRoute(routeId){
    routeEntities.forEach(r => {
      if (r.id === routeId) {
        r.entity.polyline.width = 6;
        r.entity.polyline.material = (r.mode === 'own')
          ? Cesium.Color.fromBytes(0,200,80,255)
          : Cesium.Color.fromBytes(255,80,80,255);
        viewer.flyTo(r.entity, { duration: 0.8 });
      } else {
        r.entity.polyline.width = 2;
        r.entity.polyline.material = (r.mode === 'own')
          ? Cesium.Color.fromBytes(22,143,58,230)
          : Cesium.Color.fromBytes(214,39,40,230);
      }
    });
  }

  function estimateDistanceKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
              Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
  }
  function toRad(d){ return d*Math.PI/180; }

// เรียก /optimize จาก Cloudflare โดยใช้ค่าจากหน้าเว็บ
async function callOptimizeDemo() {
  const summaryEl = document.getElementById('routeSummary');

  // อ่านค่าจาก input
  const demandInput = document.getElementById('optDemand');
  const distanceInput = document.getElementById('optDistance');

  const demandTon = demandInput && demandInput.value
    ? parseFloat(demandInput.value)
    : 12;
  const distanceKm = distanceInput && distanceInput.value
    ? parseFloat(distanceInput.value)
    : 300;

  // ใช้ scenarioMode จากปุ่ม chips (mixed / own / vendor)
  const scenario = scenarioMode || 'mixed';

  if (summaryEl) {
    summaryEl.innerHTML =
      `กำลังเรียก /optimize?demandTon=${demandTon}&distanceKm=${distanceKm}&scenario=${scenario} ...`;
  }

  try {
const url =
  `/optimize`
  + `?demandTon=${encodeURIComponent(demandTon)}`
  + `&distanceKm=${encodeURIComponent(distanceKm)}`
  + `&scenario=${encodeURIComponent(scenario)}`;

    const res = await fetch(url);
    if (!res.ok) {
      throw new Error('HTTP ' + res.status);
    }

    const data = await res.json();
    const best = data.best;
    const opts = data.options || [];

    const lines = [];
    lines.push('<b>ผลจาก /optimize (Cloudflare Functions)</b>');
    lines.push(
      `Input: ${data.input.demandTon} ton, `
      + `${data.input.distanceKm} km, `
      + `Scenario: ${data.input.scenario}`
    );

    opts.forEach((opt, i) => {
      lines.push(
        `ตัวเลือก ${i+1}: ${opt.mode} - ${opt.truckLabel || opt.truckId}, `
        + `Trips: ${opt.trips}, `
        + `Cost: ${opt.totalCost.toFixed(0)} บาท `
        + `(${opt.costPerTon.toFixed(0)} บาท/ton)`
      );
    });

    if (best) {
      lines.push(
        `<span style="color:#168f3a;"><b>แนะนำ:</b> `
        + `${best.mode} - ${best.truckLabel || best.truckId}, `
        + `${best.totalCost.toFixed(0)} บาท `
        + `(${best.costPerTon.toFixed(0)} บาท/ton)</span>`
      );
    }

    if (summaryEl) {
      summaryEl.innerHTML = lines.join('<br/>');
    }
  } catch (err) {
    console.error(err);
    if (summaryEl) {
      summaryEl.innerHTML = 'เรียก /optimize ไม่สำเร็จ: ' + err.message;
    }
  }
}
  // ===== ทดสอบเรียก /tariff/calc =====
async function callTariffDemo() {
  const summaryEl = document.getElementById('routeSummary');
  if (!summaryEl) return;

  const demandInput = document.getElementById('optDemand');
  const distanceInput = document.getElementById('optDistance');

  const weightTon = demandInput && demandInput.value
    ? parseFloat(demandInput.value)
    : 8;

  const distanceKmInput = distanceInput && distanceInput.value
    ? parseFloat(distanceInput.value)
    : 250;

  // ใช้ plant ที่เลือกเป็นปลายทาง
  const plantSelect = document.getElementById('plantSelect');
  const plantId = plantSelect ? plantSelect.value : null;
  const plant = locations.find(l => l.locationId === plantId && l.type === 'plant');

  // เอา origin ตัวอย่าง: จุดแรกที่เป็นลานหรือร้าน
  const origin = locations.find(l => l.type === 'yard' || l.type === 'junkshop');

  if (!plant || !origin) {
    summaryEl.innerHTML = 'ยังไม่มีข้อมูล Plant หรือ Origin ที่ใช้ทดสอบ Tariff';
    return;
  }

  // คำนวณระยะจริงจาก lat/lng ถ้าไม่กรอกเอง
  const distanceKm = distanceKmInput || estimateDistanceKm(origin.lat, origin.lng, plant.lat, plant.lng) * 2;

  // map scenario → vendorType
  let vendorType = 'OWN';
  if (scenarioMode === 'vendor') vendorType = 'SUB';
  if (scenarioMode === 'mixed') vendorType = 'OWN';

  const vehicleType = '6W';
  const stops = 3;

  const url =
    `/tariff/calc`
    + `?origin=${encodeURIComponent(origin.locationId)}`
    + `&destination=${encodeURIComponent(plant.locationId)}`
    + `&distanceKm=${encodeURIComponent(distanceKm)}`
    + `&weightTon=${encodeURIComponent(weightTon)}`
    + `&stops=${encodeURIComponent(stops)}`
    + `&vehicleType=${encodeURIComponent(vehicleType)}`
    + `&vendorType=${encodeURIComponent(vendorType)}`;

  summaryEl.innerHTML = 'กำลังเรียก ' + url + ' ...';

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (!res.ok) {
      summaryEl.innerHTML = 'Error: ' + (data.message || res.status);
      return;
    }

    const b = data.breakdown;
    const m = data.meta;

    const lines = [];
    lines.push('<b>ผลคำนวณค่าขนส่ง (Tariff Demo)</b>');
    lines.push(
      `จาก ${origin.name} → ${plant.name} `
      + `(${data.input.distanceKm} km, ${data.input.weightTon} ton)`
    );
    lines.push(
      `Vehicle: ${data.input.vehicleType}, Vendor: ${data.input.vendorType}`
    );
    lines.push(`Base Freight: ${b.baseFreight.toLocaleString()} บาท`);
    lines.push(`Extra Stops: ${b.extraStopCharge.toLocaleString()} บาท`);
    lines.push(
      `Fuel Cost (@${m.fuelPrice} บ./ลิตร): ${b.fuelCost.toLocaleString()} บาท`
    );
    lines.push(`<b>Total: ${b.total.toLocaleString()} บาท</b>`);
    if (m.remark && m.remark.length) {
      lines.push(
        `<span style="font-size:9px;color:#888;">${m.remark.join(' | ')}</span>`
      );
    }

    summaryEl.innerHTML = lines.join('<br/>');
  } catch (err) {
    console.error(err);
    summaryEl.innerHTML = 'เรียก /tariff/calc ไม่สำเร็จ: ' + err.message;
  }
}


</script>    
</body>
</html>
















