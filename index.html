<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Logistics Planner 3D | Recycling Fleet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Widgets/widgets.css">
  <style>
    :root {
      --brand:#168f3a;
      --bg:#f4f6f4;
      --ink:#132321;
      --card:#ffffff;
      --border:#d6e4da;
      --muted:#6b7b72;
    }
    *{box-sizing:border-box;font-family:"Segoe UI","Kanit",sans-serif;}
    body{
      margin:0;
      display:flex;
      flex-direction:row;
      height:100vh;
      background:var(--bg);
      color:var(--ink);
    }
    #sidebar{
      width:380px;
      padding:12px 14px;
      border-right:1px solid var(--border);
      background:rgba(255,255,255,0.98);
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow-y:auto;
    }
    .brand{
      font-weight:700;
      font-size:20px;
      color:var(--brand);
    }
    .tagline{
      font-size:11px;
      color:var(--muted);
      margin-top:-2px;
    }
    .top-tabs{
      display:flex;
      gap:4px;
      margin-top:8px;
      margin-bottom:2px;
      font-size:10px;
    }
    .top-tab{
      flex:1;
      text-align:center;
      padding:4px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      color:var(--muted);
      background:#fff;
    }
    .top-tab.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
      font-weight:600;
    }
    label{
      font-size:11px;
      color:#445;
      margin-top:2px;
    }
    select,button,input{
      width:100%;
      padding:6px 8px;
      margin-top:2px;
      font-size:11px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#fff;
    }
    button{
      background:var(--brand);
      color:#fff;
      font-weight:600;
      border:none;
      cursor:pointer;
    }
    button:hover{opacity:0.9;}
    .section{
      padding:8px;
      background:var(--card);
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.03);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }
    .chip{
      padding:2px 6px;
      border-radius:999px;
      font-size:9px;
      border:1px solid var(--border);
      background:#f7faf7;
      cursor:pointer;
      color:#445;
    }
    .chip.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    #routeSummary{
      font-size:10px;
      line-height:1.5;
      max-height:210px;
      overflow-y:auto;
      margin-top:4px;
      border-top:1px dashed var(--border);
      padding-top:4px;
    }
    .route-row{
      padding:3px 4px;
      border-radius:6px;
      margin-bottom:3px;
      cursor:pointer;
    }
    .route-row:hover{
      background:#eef8f0;
    }
    .route-row.own{border-left:3px solid #168f3a;}
    .route-row.vendor{border-left:3px solid #d62728;}
    #cesiumContainer{flex:1;}
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:9px;
      margin-top:2px;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:3px;
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:999px;
      display:inline-block;
    }
    .dot-plant{background:#1f77b4;}
    .dot-yard{background:#ff7f0e;}
    .dot-js{background:#2ca02c;}
    .dot-depot{background:#9467bd;}
    .dot-route-own{background:#168f3a;}
    .dot-route-out{background:#d62728;}
    .hint{
      font-size:8px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div>
      <div class="brand">Logistics Planner 3D</div>
      <div class="tagline">‡πÄ‡∏´‡πá‡∏ô Route ‡∏ä‡∏±‡∏î ‚Ä¢ ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏Ñ‡∏∏‡πâ‡∏°‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
    </div>

    <!-- Top menu (future-ready) -->
    <div class="top-tabs">
      <div class="top-tab active" data-view="planning">Planning</div>
      <div class="top-tab" data-view="cost">Cost</div>
      <div class="top-tab" data-view="tracking">Tracking</div>
      <div class="top-tab" data-view="reports">Reports</div>
    </div>

    <!-- Scenario -->
    <div class="section" data-panel="planning">
      <label>Scenario ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</label>
      <div class="chips" id="scenarioChips">
        <div class="chip active" data-mode="mixed">Mixed (Own + Outsource)</div>
        <div class="chip" data-mode="own">Own Only</div>
        <div class="chip" data-mode="vendor">Outsource Only</div>
      </div>
    </div>

    <!-- Planning controls -->
    <div class="section" data-panel="planning">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (Plant)</label>
      <select id="plantSelect"></select>

      <label>‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label>
      <select id="originTypeSelect">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="yard">‡∏•‡∏≤‡∏ô</option>
        <option value="junkshop">‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠</option>
      </select>

      <button id="btnPlan" style="margin-top:6px;background:#168f3a;">
        ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ú‡∏ô‡∏à‡∏≤‡∏Å Orders.json
      </button>

      <button id="btnTestOptimize" style="margin-top:4px;background:#444;">
        ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Optimize API (Cloudflare)
      </button>

      <div style="margin-top:4px; font-size:9px; color:#555;">
        ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ /optimize ‡πÅ‡∏•‡∏∞ /tariff/calc):
      </div>

      <label style="font-size:9px;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏° (‡∏ï‡∏±‡∏ô)</label>
      <input id="optDemand" type="number" step="0.1" value="12"
        style="width:100%;padding:4px 6px;font-size:9px;border-radius:6px;border:1px solid #d6e4da;">

      <label style="font-size:9px;">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏õ-‡∏Å‡∏•‡∏±‡∏ö (‡∏Å‡∏°.)</label>
      <input id="optDistance" type="number" step="10" value="300"
        style="width:100%;padding:4px 6px;font-size:9px;border-radius:6px;border:1px solid #d6e4da;">

      <button id="btnTestTariff" style="margin-top:4px;background:#0066aa;">
        ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (Tariff)
      </button>

      <div class="hint">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ Scenario ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô (Mixed / Own / Outsource) ‡πÅ‡∏•‡∏∞ Plant ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
      </div>
    </div>

    <!-- Legend -->
    <div class="section" data-panel="planning">
      <div class="legend">
        <span><span class="dot dot-plant"></span>Plant</span>
        <span><span class="dot dot-yard"></span>Yard</span>
        <span><span class="dot dot-js"></span>Junk Shop</span>
        <span><span class="dot dot-depot"></span>Depot</span>
        <span><span class="dot dot-route-own"></span>Route Own</span>
        <span><span class="dot dot-route-out"></span>Route Outsource</span>
      </div>
      <div class="hint">
        ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Route ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
      </div>
    </div>

    <!-- Summary -->
    <div class="section" data-panel="planning">
      <div style="font-size:11px;font-weight:600;">
        ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á & ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
      </div>
      <div id="routeSummary">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô orders.json ‚Üí ‡∏£‡∏ß‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î ‚Üí ‡∏ß‡∏≤‡∏á Route 1,2,3...
        ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô Own vs Outsource ‡πÅ‡∏•‡∏∞ Tariff
      </div>
    </div>

    <!-- Panels‡∏≠‡∏∑‡πà‡∏ô (Cost/Tracking/Reports) ‡πÑ‡∏ß‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á -->
    <div class="section" data-panel="cost" style="display:none;">
      <div style="font-size:11px;font-weight:600;">Truck Load Planner</div>
      <div class="hint">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ 1 ‡∏Ñ‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
        ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏£‡∏ñ
      </div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å</label>
  <select id="loadTruckSelect">
    <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å initUI() -->
  </select>

  <div class="hint">‡πÅ‡∏ñ‡∏ß‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.) ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>

  <div class="load-row" style="display:flex;gap:4px;align-items:center;margin-top:4px;">
    <select class="load-material" style="flex:2;">
      <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -</option>
    </select>
    <input class="load-weight" type="number" min="0" step="50" placeholder="‡∏Å‡∏Å."
      style="flex:1;">
  </div>
  <div class="load-row" style="display:flex;gap:4px;align-items:center;">
    <select class="load-material" style="flex:2;">
      <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -</option>
    </select>
    <input class="load-weight" type="number" min="0" step="50" placeholder="‡∏Å‡∏Å."
      style="flex:1;">
  </div>
  <div class="load-row" style="display:flex;gap:4px;align-items:center;">
    <select class="load-material" style="flex:2;">
      <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -</option>
    </select>
    <input class="load-weight" type="number" min="0" step="50" placeholder="‡∏Å‡∏Å."
      style="flex:1;">
  </div>

  <div id="loadResult" style="font-size:10px;margin-top:6px;border-top:1px dashed var(--border);padding-top:4px;">
    ‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å...
  </div>

  <div class="hint">
    ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°" (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏≠‡∏±‡∏î‡∏Å‡πâ‡∏≠‡∏ô, PET, UBC, HDPE ‡∏Ø‡∏•‡∏Ø)
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ñ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô materials.json
  </div>
</div>
    
    <div class="section" data-panel="tracking" style="display:none;">
      <div style="font-size:11px;font-weight:600;">Tracking View (Coming Next)</div>
      <div class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS / Shipment Status / Alert ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå.</div>
    </div>
    <div class="section" data-panel="reports" style="display:none;">
      <div style="font-size:11px;font-weight:600;">Reports View (Coming Next)</div>
      <div class="hint">Dashboard KPI ‡∏Ç‡∏ô‡∏™‡πà‡∏á / Load Factor / Cost per Ton / SLA.</div>
    </div>
  </div>

  <div id="cesiumContainer"></div>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Cesium.js"></script>
  <script>
    // ‡πÉ‡∏ä‡πâ Token Cesium Ion ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkYWQ1OWUwOS1mYjE3LTRkMWItYmVmOC1mNGY2MDljOGJhMWIiLCJpZCI6MzU4MDMzLCJpYXQiOjE3NjI0ODM2ODh9.m6qoHZhEGlI40OWp5E7x5v8YIFIzTTiyhYV5T-50BAQ';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      animation:false,
      timeline:false,
      baseLayerPicker:true,
      geocoder:false,
      sceneModePicker:true
    });
function flyToThailand() {
  viewer.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(100.5, 15.5, 2500000.0)
  });
}

    let locations = [];
    let materials = [];
    let trucks = [];
    let orders = [];
    let scenarioMode = 'mixed';
    let routeEntities = [];

    // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ü‡∏Å‡∏±‡∏™ Route ‡πÑ‡∏î‡πâ
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(click) {
      const picked = viewer.scene.pick(click.position);
      if (picked && picked.id) {
        const match = routeEntities.find(r => r.entity === picked.id);
        if (match) {
          focusRoute(match.id);
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    Promise.all([
      fetch('locations.json').then(r => r.json()),
      fetch('materials.json').then(r => r.json()),
      fetch('trucks.json').then(r => r.json()),
      fetch('orders.json').then(r => r.ok ? r.json() : [])
    ]).then(([loc, mat, trk, ord]) => {
      locations = loc;
      materials = mat;
      trucks = trk;
      orders = ord || [];
      initUI();
      plotLocations();
      flyToThailand();
    }).catch(err => {
      console.error(err);
      const el = document.getElementById('routeSummary');
      if (el) el.innerHTML = '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
    });

function initUI(){
  // --- top tabs: ‡∏™‡∏•‡∏±‡∏ö panel ---
  function showPanels(view) {
    document.querySelectorAll('[data-panel]').forEach(p => {
      if (view === 'planning') {
        p.style.display = (p.dataset.panel === 'planning') ? 'flex' : 'none';
      } else {
        p.style.display = (p.dataset.panel === view) ? 'flex' : 'none';
      }
    });
  }
  
  showPanels('planning');
    document.querySelectorAll('.top-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.top-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const view = tab.dataset.view;
      showPanels(view);
    });
  });

  // --- plant select ---
  const plantSelect = document.getElementById('plantSelect');
  if (plantSelect) {
    locations.filter(l => l.type === 'plant').forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.locationId;
      opt.textContent = p.name;
      plantSelect.appendChild(opt);
    });
    if (plantSelect.options.length > 0) {
      plantSelect.selectedIndex = 0;
    }
  }

    // --- scenario chips ---
  const chips = document.querySelectorAll('#scenarioChips .chip');
  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      chips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      scenarioMode = chip.dataset.mode;
    });
  });

// --- ‡∏õ‡∏∏‡πà‡∏° planning ---
  const planBtn = document.getElementById('btnPlan');
  if (planBtn) planBtn.addEventListener('click', buildPlanFromOrders);

  const btnTest = document.getElementById('btnTestOptimize');
  if (btnTest) btnTest.addEventListener('click', callOptimizeDemo);

  const btnTariff = document.getElementById('btnTestTariff');
  if (btnTariff) btnTariff.addEventListener('click', callTariffDemo);

    function flyToThailand(){
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(100.5, 15.5, 2500000.0)
      });
    }

  // --- event ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Cost tab) ---
  const loadTruckSelect = document.getElementById('loadTruckSelect');
  const loadRows = document.querySelectorAll('.load-row input, .load-row select');

 if (loadTruckSelect) {
    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ
    trucks.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id || t.truckId || t.displayName || t.truckType;
      opt.textContent = (t.displayName || t.truckType || opt.value) +
        (t.ownerType ? ` (${t.ownerType})` : '');
      opt.dataset.maxWeightKgLegal = t.maxWeightKgLegal || (t.maxTon ? t.maxTon*1000 : '');
      opt.dataset.maxVolumeM3 = t.maxVolumeM3 || '';
    });
    loadTruckSelect.selectedIndex = 0;
    loadTruckSelect.addEventListener('change', updateLoadDashboard);
  }

    loadRows.forEach(el => {
    el.addEventListener('input', updateLoadDashboard);
    el.addEventListener('change', updateLoadDashboard);
  });

  // initial
  updateLoadDashboard();
}

    function plotLocations(){
      locations.forEach(loc => {
        let color = Cesium.Color.WHITE;
        if(loc.type === 'plant') color = Cesium.Color.fromBytes(31,119,180);
        if(loc.type === 'yard') color = Cesium.Color.fromBytes(255,127,14);
        if(loc.type === 'junkshop') color = Cesium.Color.fromBytes(44,160,44);
        if(loc.type === 'depot') color = Cesium.Color.fromBytes(148,103,189);

        viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(loc.lng, loc.lat),
          point: {
            pixelSize: 9,
            color: color,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 1
          },
          label: {
            text: loc.name,
            font: '10px sans-serif',
            pixelOffset: new Cesium.Cartesian2(0, -14),
            fillColor: Cesium.Color.fromCssColorString('#223'),
            showBackground: true,
            backgroundColor: Cesium.Color.fromCssColorString('rgba(255,255,255,0.85)'),
            scaleByDistance: new Cesium.NearFarScalar(50000,1.0,800000,0.25)
          },
          properties: {
            locationId: loc.locationId,
            type: loc.type
          }
        });
      });
    }

    function clearRoutes(){
      routeEntities.forEach(r => viewer.entities.remove(r.entity));
      routeEntities = [];
    }

    function buildPlanFromOrders(){
      clearRoutes();
      const summaryEl = document.getElementById('routeSummary');
      if (summaryEl) summaryEl.innerHTML = '';

      const plantSelect = document.getElementById('plantSelect');
      const plantId = plantSelect ? plantSelect.value : null;
      const originTypeFilter = document.getElementById('originTypeSelect')?.value || 'all';
      const plant = locations.find(l => l.locationId === plantId);

      if (!plant) {
        if (summaryEl) summaryEl.innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Plant ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô locations.json';
        return;
      }

const demandByOrigin = {};
(orders || []).forEach(order => {
  const origin = locations.find(l => l.locationId === order.originLocationId);
  if (!origin) return;
  if (originTypeFilter !== 'all' && origin.type !== originTypeFilter) return;

  if (!demandByOrigin[origin.locationId]) {
    demandByOrigin[origin.locationId] = {
      weightKg: 0,
      volumeM3: 0,
      origin,
      byMaterial: {}
    };
  }
  const d = demandByOrigin[origin.locationId];

  (order.lines || []).forEach(line => {
    const mat = materials.find(m => m.materialId === line.materialId);
    if (!mat) return;

    const w = (mat.avgWeightPerUnitKg || 0) * line.qtyUnit;
    const v = (mat.avgVolumePerUnitM3 || 0) * line.qtyUnit;
    d.weightKg += w;
    d.volumeM3 += v;

    const mid = mat.materialId || mat.code || mat.name;
    if (!d.byMaterial[mid]) {
      d.byMaterial[mid] = {
        material: mat,
        weightKg: 0,
        volumeM3: 0
      };
    }
    d.byMaterial[mid].weightKg += w;
    d.byMaterial[mid].volumeM3 += v;
  });
});
      const originIds = Object.keys(demandByOrigin);
      if (originIds.length === 0) {
        if (summaryEl) summaryEl.innerHTML = '‡πÑ‡∏°‡πà‡∏°‡∏µ orders ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö filter ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ orders.json';
        return;
      }

      const ownTrucks = trucks.filter(t => t.ownerType === 'OWN');
      const vendorTrucks = trucks.filter(t => t.ownerType === 'OUTSOURCE');

      let routeHtml = '';
      let routeIndex = 1;
      let totalCost = 0;
      let totalTon = 0;

      originIds.forEach(originId => {
        const d = demandByOrigin[originId];
        const origin = d.origin;
        let remainingKg = d.weightKg;
        let remainingVol = d.volumeM3;
        if (remainingKg <= 0 || remainingVol <= 0) return;

        const distanceKm = estimateDistanceKm(origin.lat, origin.lng, plant.lat, plant.lng);

        const byMat = d.byMaterial || {};
const remainingByMat = {};
Object.keys(byMat).forEach(mid => {
  remainingByMat[mid] = {
    material: byMat[mid].material,
    weightKg: byMat[mid].weightKg,
    volumeM3: byMat[mid].volumeM3
  };
});

        while (remainingKg > 50) {
          const candidates = [];

          if (scenarioMode === 'mixed' || scenarioMode === 'own') {
            ownTrucks.forEach(tr => {
              const cap = computeLoadableTonForTruck(tr, remainingKg, remainingVol, d);
              if (cap.ton > 0) {
                const tripCost = tr.fixedCostPerTrip + tr.costPerKm * distanceKm * 2;
                const cpt = tripCost / cap.ton;
                candidates.push({ mode:'own', truck:tr, ton:cap.ton, cost:tripCost, costPerTon:cpt });
              }
            });
          }

          if (scenarioMode === 'mixed' || scenarioMode === 'vendor') {
            vendorTrucks.forEach(tr => {
              const cap = computeLoadableTonForTruck(tr, remainingKg, remainingVol, d);
              if (cap.ton > 0) {
                let tripCost = 0;
                if (tr.rateType === 'per_ton_km') {
                  tripCost = tr.rateValue * distanceKm * 2 * cap.ton;
                } else if (tr.rateType === 'per_km') {
                  tripCost = tr.rateValue * distanceKm * 2;
                }
                if (tr.minCharge && tripCost < tr.minCharge) tripCost = tr.minCharge;
                const cpt = tripCost / cap.ton;
                candidates.push({ mode:'vendor', truck:tr, ton:cap.ton, cost:tripCost, costPerTon:cpt });
              }
            });
          }

          if (candidates.length === 0) break;

          candidates.sort((a,b)=>a.costPerTon - b.costPerTon);
          const chosen = candidates[0];

          remainingKg -= chosen.ton * 1000;
          const density = d.volumeM3 > 0 ? (d.weightKg / d.volumeM3) : 1000;
          const usedVol = (chosen.ton * 1000) / density;
          remainingVol -= usedVol;

          // ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ç‡∏ô (kg)
const assignKg = chosen.ton * 1000;

// ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢ assignKg ‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô material ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
const routeMat = {};
let assignedKg = 0;
let assignedVol = 0;

// ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å remainingByMat)
const totalRemainKg = Object.values(remainingByMat)
  .reduce((s, m) => s + (m.weightKg || 0), 0) || 1;

Object.keys(remainingByMat).forEach(mid => {
  const rm = remainingByMat[mid];
  if (rm.weightKg <= 0) return;

  const ratio = rm.weightKg / totalRemainKg;
  let w = assignKg * ratio;
  if (w > rm.weightKg) w = rm.weightKg;
  if (w <= 0) return;

  const volPerKg = (rm.volumeM3 && rm.weightKg) ? (rm.volumeM3 / rm.weightKg) : 0;
  const v = volPerKg ? w * volPerKg : 0;

  rm.weightKg -= w;
  if (rm.volumeM3) rm.volumeM3 = Math.max(0, rm.volumeM3 - v);

  assignedKg += w;
  assignedVol += v;

  if (!routeMat[mid]) {
    routeMat[mid] = { material: rm.material, weightKg: 0, volumeM3: 0 };
  }
  routeMat[mid].weightKg += w;
  routeMat[mid].volumeM3 += v;
});

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö origin ‡∏ô‡∏µ‡πâ
remainingKg = Math.max(0, remainingKg - assignedKg);
remainingVol = Math.max(0, remainingVol - assignedVol);

          
          const color = (chosen.mode === 'own')
            ? Cesium.Color.fromBytes(22,143,58,230)
            : Cesium.Color.fromBytes(214,39,40,230);

          const entity = viewer.entities.add({
            polyline: {
              positions: Cesium.Cartesian3.fromDegreesArray([
                plant.lng, plant.lat,
                origin.lng, origin.lat,
                plant.lng, plant.lat
              ]),
              width: 2 + chosen.ton,
              material: color
            }
          });

const routeId = 'R' + routeIndex;
routeEntities.push({
  id: routeId,
  entity,
  mode: chosen.mode,
  originId: origin.locationId,
  plantId: plant.locationId,
  ton: chosen.ton,
  distanceKm: distanceKm * 2,
  materials: routeMat
});

          const modeLabel = chosen.mode === 'own' ? '‡∏£‡∏ñ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó' : 'Outsource';
          const truckLabel = chosen.truck.displayName || chosen.truck.vendorName || chosen.truck.truckType || chosen.truck.id;
          const loadPct = (chosen.ton * 1000) / (chosen.truck.maxWeightKgLegal || chosen.truck.maxTon * 1000) * 100;
          const etaHours = (distanceKm * 2) / 60; // 60 km/h
          const departTime = "08:00";
          const arrivalTime = addHoursToTime(departTime, etaHours);

          const matList = Object.values(routeMat)
  .filter(m => m.weightKg > 0)
  .sort((a, b) => b.weightKg - a.weightKg)
  .slice(0, 3)
  .map(m => {
    const name = m.material.name || m.material.materialId || 'Material';
    return `${name}: ${(m.weightKg/1000).toFixed(2)}t`;
  })
  .join(', ');

routeHtml += `
  <div class="route-row ${chosen.mode === 'own' ? 'own':'vendor'}" data-route-id="${routeId}">
    <b>Route ${routeIndex}:</b> ${origin.name} ‚Üí ${plant.name}<br/>
    ${modeLabel} (${truckLabel}) |
    Load ~ ${chosen.ton.toFixed(2)} ton (${loadPct.toFixed(0)}% ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)<br/>
    Dist ~ ${(distanceKm*2).toFixed(1)} km |
    Cost ‚âà ${chosen.cost.toFixed(0)} ‡∏ö‡∏≤‡∏ó<br/>
    ${matList ? `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å: ${matList}<br/>` : ''}
    ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å ${departTime} ~ ‡∏ñ‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${arrivalTime}
  </div>
`;

          totalCost += chosen.cost;
          totalTon += chosen.ton;
          routeIndex++;
        }
      });

      if (routeIndex === 1) {
        if (summaryEl) summaryEl.innerHTML = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î Route ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏°‡∏µ candidates ‡∏´‡∏£‡∏∑‡∏≠ orders)';
        return;
      }

      if (totalTon > 0) {
        const avg = totalCost / totalTon;
        routeHtml += `
          <hr/>
          <div>
            <b>‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ú‡∏ô (Heuristic)</b><br/>
            ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏° ~ ${totalTon.toFixed(2)} ton<br/>
            ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° ~ ${totalCost.toFixed(0)} ‡∏ö‡∏≤‡∏ó<br/>
            ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~ ${avg.toFixed(0)} ‡∏ö‡∏≤‡∏ó/ton
          </div>
        `;
      }

      if (summaryEl) summaryEl.innerHTML = routeHtml;

document.querySelectorAll('.route-row').forEach(row => {
  row.addEventListener('click', () => {
    const id = row.getAttribute('data-route-id');
    focusRoute(id);
    prefillLoadFromRoute(id); // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
  });
});

      function prefillLoadFromRoute(routeId) {
  const route = routeEntities.find(r => r.id === routeId);
  if (!route || !route.materials) return;

  // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö Cost (Truck Load Planner)
  const tabCost = document.querySelector('.top-tab[data-view="cost"]');
  if (tabCost) tabCost.click();

  const panel = document.querySelector('[data-panel="cost"]');
  if (!panel) return;

  const truckSelect = document.getElementById('loadTruckSelect');
  const materialSelects = panel.querySelectorAll('.load-material');
  const weightInputs = panel.querySelectorAll('.load-weight');

  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏ï‡∏≤‡∏° route (own / vendor)
  if (truckSelect && trucks && trucks.length) {
    const owner = route.mode === 'own' ? 'OWN' : 'OUTSOURCE';
    let foundIndex = 0;
    trucks.forEach((t, i) => {
      if ((t.ownerType || '').toUpperCase() === owner && foundIndex === 0) {
        foundIndex = i;
      }
    });
    if (truckSelect.options[foundIndex]) {
      truckSelect.selectedIndex = foundIndex;
    }
  }

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å route ‡∏•‡∏á 3 ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å
  const mats = Object.values(route.materials)
    .filter(m => m.weightKg > 0)
    .sort((a, b) => b.weightKg - a.weightKg);

  materialSelects.forEach((sel, i) => {
    const input = weightInputs[i];
    if (!sel || !input) return;

    if (i < mats.length) {
      const mat = mats[i].material;
      const targetId = mat.materialId || mat.code || mat.name;

      // ‡∏´‡∏≤ option ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö material
      let set = false;
      for (let o = 0; o < sel.options.length; o++) {
        if (
          sel.options[o].value === targetId ||
          sel.options[o].textContent === (mat.name || targetId)
        ) {
          sel.selectedIndex = o;
          set = true;
          break;
        }
      }
      if (!set) sel.selectedIndex = 0;

      input.value = Math.round(mats[i].weightKg); // kg
    } else {
      sel.selectedIndex = 0;
      input.value = '';
    }
  });

  updateLoadDashboard();
}


      // ‡πÄ‡∏ï‡∏¥‡∏° Tariff ‡∏à‡∏≤‡∏Å API
      enrichRoutesWithTariff();
    }

    // ‡πÄ‡∏ï‡∏¥‡∏° Tariff ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Route
    async function enrichRoutesWithTariff() {
      const summaryEl = document.getElementById('routeSummary');
      if (!summaryEl || routeEntities.length === 0) return;

      try {
        const calls = routeEntities.map(r => {
          const url =
            `/tariff/calc`
            + `?origin=${encodeURIComponent(r.originId)}`
            + `&destination=${encodeURIComponent(r.plantId)}`
            + `&distanceKm=${encodeURIComponent(r.distanceKm)}`
            + `&weightTon=${encodeURIComponent(r.ton)}`
            + `&stops=${encodeURIComponent(3)}`
            + `&vehicleType=${encodeURIComponent('10W')}`
            + `&vendorType=${encodeURIComponent(r.mode === 'own' ? 'OWN' : 'SUB')}`;

          return fetch(url).then(res =>
            res.json().then(data => ({ res, data, id: r.id }))
          );
        });

        const results = await Promise.all(calls);

        results.forEach(({ res, data, id }) => {
          if (!res || !res.ok || !data || !data.breakdown) return;
          const row = document.querySelector(`.route-row[data-route-id="${id}"]`);
          if (!row) return;
          const b = data.breakdown;
          const costPerTon = b.total / (data.input.weightTon || 1);

          const extra = `
            <div style="font-size:9px;color:#444;">
              Tariff Total: ${b.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó
              (${costPerTon.toFixed(0)} ‡∏ö./ton ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô)
            </div>
          `;
          row.insertAdjacentHTML('beforeend', extra);
        });

        let total = 0;
        let totalTon = 0;
        results.forEach(({ res, data }) => {
          if (!res || !res.ok || !data || !data.breakdown) return;
          total += data.breakdown.total || 0;
          totalTon += data.input.weightTon || 0;
        });

        if (totalTon > 0) {
          const avg = total / totalTon;
          summaryEl.insertAdjacentHTML(
            'beforeend',
            `
            <hr/>
            <div style="font-size:10px;">
              <b>Tariff Summary (‡∏ó‡∏∏‡∏Å Route):</b><br/>
              ‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡∏≤‡∏° Tariff ~ ${total.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br/>
              ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~ ${avg.toFixed(0)} ‡∏ö‡∏≤‡∏ó/ton
            </div>
            `
          );
        }
      } catch (err) {
        console.error(err);
      }
    }

    function addHoursToTime(timeStr, hours) {
      const [h, m] = timeStr.split(':').map(Number);
      const totalMinutes = h * 60 + m + Math.round(hours * 60);
      const hh = Math.floor((totalMinutes / 60) % 24).toString().padStart(2, '0');
      const mm = (totalMinutes % 60).toString().padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function computeLoadableTonForTruck(truck, remainingKg, remainingVol, demand){
      const legalKg = truck.maxWeightKgLegal || (truck.maxTon ? truck.maxTon * 1000 : 0);
      const maxTonByWeight = legalKg > 0 ? legalKg / 1000 : 9999;
      const density = demand.volumeM3 > 0 ? (demand.weightKg / demand.volumeM3) : 1000;
      const maxTonByVolume = (truck.maxVolumeM3 || 9999) * density / 1000;
      let maxTon = Math.min(maxTonByWeight, maxTonByVolume);
      const remainTon = remainingKg / 1000;
      if (maxTon > remainTon) maxTon = remainTon;
      if (maxTon < 0.5) return { ton:0 };
      return { ton:maxTon };
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ô‡∏£‡∏ñ 1 ‡∏Ñ‡∏±‡∏ô (‡∏´‡∏ô‡πâ‡∏≤ Cost / Truck Load Planner)
function updateLoadDashboard() {
  const panel = document.querySelector('[data-panel="cost"]');
  if (!panel) return;

  const truckSelect = document.getElementById('loadTruckSelect');
  const resultEl = document.getElementById('loadResult');
  const materialSelects = panel.querySelectorAll('.load-material');
  const weightInputs = panel.querySelectorAll('.load-weight');

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ materials ‡πÉ‡∏™‡πà‡πÉ‡∏ô dropdown ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  if (materialSelects.length && materials && materials.length) {
    materialSelects.forEach(sel => {
      if (sel.options.length <= 1) {
        materials.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.materialId || m.code || m.name;
          opt.textContent = m.name || m.materialId || m.code;
          opt.dataset.avgWeightPerUnitKg = m.avgWeightPerUnitKg || '';
          opt.dataset.avgVolumePerUnitM3 = m.avgVolumePerUnitM3 || '';
          sel.appendChild(opt);
        });
      }
    });
  }

  if (!truckSelect || !resultEl) return;
  const selectedIdx = truckSelect.selectedIndex;
  if (selectedIdx < 0) {
    resultEl.innerHTML = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ';
    return;
  }

  // ‡∏´‡∏≤ truck object ‡∏à‡∏≤‡∏Å trucks
  const selectedLabel = truckSelect.options[selectedIdx].textContent;
  const truck = trucks.find(t =>
    selectedLabel.includes(t.displayName || '') ||
    selectedLabel.includes(t.truckType || '')
  ) || trucks[0];

  if (!truck) {
    resultEl.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ';
    return;
  }

  const legalKg = truck.maxWeightKgLegal || (truck.maxTon ? truck.maxTon * 1000 : 0);
  const capVol = truck.maxVolumeM3 || null;

  let totalKg = 0;
  let totalVol = 0;

  // ‡∏£‡∏ß‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞ material
  materialSelects.forEach((sel, i) => {
    const matId = sel.value;
    const weightKg = parseFloat(weightInputs[i].value || '0');
    if (!matId || !weightKg || weightKg <= 0) return;

    const mat = materials.find(m =>
      m.materialId === matId || m.code === matId || m.name === sel.options[sel.selectedIndex].textContent
    );
    totalKg += weightKg;

    if (mat && mat.avgVolumePerUnitM3 && mat.avgWeightPerUnitKg) {
      // ‡∏Ñ‡∏¥‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
      const volPerKg = mat.avgVolumePerUnitM3 / mat.avgWeightPerUnitKg;
      totalVol += weightKg * volPerKg;
    }
  });

  if (totalKg === 0) {
    resultEl.innerHTML = '‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏ô‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏Å‡∏Å.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏£‡∏ñ';
    return;
  }

  const utilWeight = legalKg ? (totalKg / legalKg) * 100 : null;
  const utilVol = (capVol && totalVol)
    ? (totalVol / capVol) * 100
    : null;

  let html = '';
  html += `<b>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ: ${selectedLabel}</b><br/>`;
  html += `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${totalKg.toLocaleString()} ‡∏Å‡∏Å.<br/>`;
  if (legalKg) {
    html += `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢: ${legalKg.toLocaleString()} ‡∏Å‡∏Å.<br/>`;
    html += `‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ‚âà ${utilWeight.toFixed(1)}%<br/>`;
  } else {
    html += `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ (maxWeightKgLegal) ‡πÉ‡∏ô trucks.json<br/>`;
  }

  if (capVol && totalVol) {
    html += `‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${totalVol.toFixed(2)} m¬≥ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ ${capVol} m¬≥ `
      + `(${utilVol.toFixed(1)}%)<br/>`;
  }

  // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏ô
  if (utilWeight && utilWeight > 100) {
    html += `<span style="color:#d62728;font-weight:600;">‡πÄ‡∏Å‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏•‡∏á</span><br/>`;
  } else if (utilWeight && utilWeight > 85) {
    html += `<span style="color:#168f3a;">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤</span><br/>`;
  }

  if (utilVol && utilVol > 100) {
    html += `<span style="color:#d62728;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏£‡∏ñ (‡∏≠‡∏≤‡∏à‡∏≠‡∏±‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠)</span><br/>`;
  }

  resultEl.innerHTML = html;
}

    
    function focusRoute(routeId){
      routeEntities.forEach(r => {
        if (r.id === routeId) {
          r.entity.polyline.width = 6;
          r.entity.polyline.material = (r.mode === 'own')
            ? Cesium.Color.fromBytes(0,200,80,255)
            : Cesium.Color.fromBytes(255,80,80,255);
          viewer.flyTo(r.entity, { duration: 0.8 });
        } else {
          r.entity.polyline.width = 2;
          r.entity.polyline.material = (r.mode === 'own')
            ? Cesium.Color.fromBytes(22,143,58,230)
            : Cesium.Color.fromBytes(214,39,40,230);
        }
      });
    }

    function estimateDistanceKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lat2-lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
                Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    function toRad(d){ return d*Math.PI/180; }

    // /optimize demo
    async function callOptimizeDemo() {
      const summaryEl = document.getElementById('routeSummary');
      const demandInput = document.getElementById('optDemand');
      const distanceInput = document.getElementById('optDistance');

      const demandTon = demandInput && demandInput.value ? parseFloat(demandInput.value) : 12;
      const distanceKm = distanceInput && distanceInput.value ? parseFloat(distanceInput.value) : 300;
      const scenario = scenarioMode || 'mixed';

      if (summaryEl) {
        summaryEl.innerHTML =
          `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /optimize?demandTon=${demandTon}&distanceKm=${distanceKm}&scenario=${scenario} ...`;
      }

      try {
        const url =
          `/optimize`
          + `?demandTon=${encodeURIComponent(demandTon)}`
          + `&distanceKm=${encodeURIComponent(distanceKm)}`
          + `&scenario=${encodeURIComponent(scenario)}`;

        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        const best = data.best;
        const opts = data.options || [];
        const lines = [];
        lines.push('<b>‡∏ú‡∏•‡∏à‡∏≤‡∏Å /optimize (Cloudflare Functions)</b>');
        lines.push(
          `Input: ${data.input.demandTon} ton, `
          + `${data.input.distanceKm} km, `
          + `Scenario: ${data.input.scenario}`
        );
        opts.forEach((opt, i) => {
          lines.push(
            `‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${i+1}: ${opt.mode} - ${opt.truckLabel || opt.truckId}, `
            + `Trips: ${opt.trips}, `
            + `Cost: ${opt.totalCost.toFixed(0)} ‡∏ö‡∏≤‡∏ó `
            + `(${opt.costPerTon.toFixed(0)} ‡∏ö‡∏≤‡∏ó/ton)`
          );
        });
        if (best) {
          lines.push(
            `<span style="color:#168f3a;"><b>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> `
            + `${best.mode} - ${best.truckLabel || best.truckId}, `
            + `${best.totalCost.toFixed(0)} ‡∏ö‡∏≤‡∏ó `
            + `(${best.costPerTon.toFixed(0)} ‡∏ö‡∏≤‡∏ó/ton)</span>`
          );
        }
        if (summaryEl) summaryEl.innerHTML = lines.join('<br/>');
      } catch (err) {
        console.error(err);
        if (summaryEl) summaryEl.innerHTML = '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /optimize ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }
    }

    // /tariff/calc demo
    async function callTariffDemo() {
      const summaryEl = document.getElementById('routeSummary');
      if (!summaryEl) return;

      const demandInput = document.getElementById('optDemand');
      const distanceInput = document.getElementById('optDistance');

      const weightTon = demandInput && demandInput.value ? parseFloat(demandInput.value) : 8;

      const plantSelect = document.getElementById('plantSelect');
      const plantId = plantSelect ? plantSelect.value : null;
      const plant = locations.find(l => l.locationId === plantId && l.type === 'plant');
      const origin = locations.find(l => l.type === 'yard' || l.type === 'junkshop');

      if (!plant || !origin) {
        summaryEl.innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Plant ‡∏´‡∏£‡∏∑‡∏≠ Origin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö Tariff';
        return;
      }

      const defaultDist = estimateDistanceKm(origin.lat, origin.lng, plant.lat, plant.lng) * 2;
      const distanceKm = distanceInput && distanceInput.value
        ? parseFloat(distanceInput.value)
        : defaultDist;

      let vendorType = 'OWN';
      if (scenarioMode === 'vendor') vendorType = 'SUB';
      if (scenarioMode === 'mixed') vendorType = 'OWN';

      const vehicleType = '6W';
      const stops = 3;

      const url =
        `/tariff/calc`
        + `?origin=${encodeURIComponent(origin.locationId)}`
        + `&destination=${encodeURIComponent(plant.locationId)}`
        + `&distanceKm=${encodeURIComponent(distanceKm)}`
        + `&weightTon=${encodeURIComponent(weightTon)}`
        + `&stops=${encodeURIComponent(stops)}`
        + `&vehicleType=${encodeURIComponent(vehicleType)}`
        + `&vendorType=${encodeURIComponent(vendorType)}`;

      summaryEl.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ' + url + ' ...';

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) {
          summaryEl.innerHTML = 'Error: ' + (data.message || res.status);
          return;
        }

        const b = data.breakdown;
        const m = data.meta;
        const lines = [];
        lines.push('<b>‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (Tariff Demo)</b>');
        lines.push(
          `‡∏à‡∏≤‡∏Å ${origin.name} ‚Üí ${plant.name} `
          + `(${data.input.distanceKm} km, ${data.input.weightTon} ton)`
        );
        lines.push(
          `Vehicle: ${data.input.vehicleType}, Vendor: ${data.input.vendorType}`
        );
        lines.push(`Base Freight: ${b.baseFreight.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
        lines.push(`Extra Stops: ${b.extraStopCharge.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
        lines.push(
          `Fuel Cost (@${m.fuelPrice} ‡∏ö./‡∏•‡∏¥‡∏ï‡∏£): `
          + `${b.fuelCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó`
        );
        lines.push(`<b>Total: ${b.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</b>`);
        if (m.remark && m.remark.length) {
          lines.push(
            `<span style="font-size:9px;color:#888;">${m.remark.join(' | ')}</span>`
          );
        }
        summaryEl.innerHTML = lines.join('<br/>');
      } catch (err) {
        console.error(err);
        summaryEl.innerHTML = '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /tariff/calc ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }
    }
  </script>
</body>
</html>




